#!/bin/bash

set -euo pipefail

# ログ出力関数（quietモードでは出力しない）
log() {
    if [[ "${QUIET:-false}" != true ]]; then
        echo "$@"
    fi
}

# .envファイルを読み込む
load_env_file() {
    local env_file="${1:-.env}"

    if [[ -f "$env_file" ]]; then
        log "Loading environment variables from $env_file"
        # 空行とコメント行を除外して読み込む
        set -a
        source <(grep -v '^#' "$env_file" | grep -v '^[[:space:]]*$')
        set +a
    fi
}

# スクリプトのディレクトリを取得
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# .envファイルを読み込む（プロジェクトルートから）
load_env_file "$PROJECT_ROOT/.env"

# 使用方法を表示
usage() {
    cat <<EOF
Usage: $0 [--tags <tags>] [--resource-groups <resource_groups>] [--dry-run] [--quiet]

Options:
    --tags <tags>                    Tags to filter VMs (optional)
                                     Format: key1=value1,key2,key3=value3
                                     - key=value: Match VMs with this exact tag
                                     - key: Match VMs that have this tag (any value)
                                     If not specified with --resource-groups, all VMs in the resource groups will be targeted
    --resource-groups <resource_groups>  Resource group names (optional, comma-separated)
    --dry-run                        Dry run mode (only show VMs, don't stop them)
    --quiet                          Quiet mode (minimal output, skip confirmation prompt)
    -h, --help                       Show this help message

Environment Variables (optional):
    AZURE_CLIENT_ID      Azure Service Principal Client ID
    AZURE_CLIENT_SECRET  Azure Service Principal Client Secret
    AZURE_TENANT_ID      Azure Tenant ID

Authentication:
    - If all three environment variables are set: Service Principal authentication
    - Otherwise: Managed Identity authentication (falls back to interactive login if not available)

Note:
    If a .env file exists in the project root, it will be automatically loaded.

Example:
    $0 --tags Environment=Production
    $0 --tags Environment=Production,AutoShutdown
    $0 --tags Environment=Production,Owner=TeamA --resource-groups myResourceGroup
    $0 --resource-groups myResourceGroup1,myResourceGroup2
    $0 --tags Environment=Production --dry-run
EOF
    exit 1
}


# タグフィルタを構築する関数
build_tag_filter() {
    local tags="$1"
    local filter_parts=()

    # カンマで分割してタグを処理
    IFS=',' read -ra TAG_ARRAY <<< "$tags"

    for tag in "${TAG_ARRAY[@]}"; do
        if [[ "$tag" == *"="* ]]; then
            # key=value形式
            key="${tag%%=*}"
            value="${tag#*=}"
            filter_parts+=("tags.\"$key\"=='$value'")
        else
            # key形式（値は任意）
            filter_parts+=("tags.\"$tag\"!=null")
        fi
    done

    # ANDでフィルタを結合
    local filter=$(printf ' && %s' "${filter_parts[@]}")
    filter="${filter:4}"  # 最初の " && " を削除
    echo "$filter"
}

# パラメータ初期化
TAGS=""
RESOURCE_GROUPS=""
DRY_RUN=false
QUIET=false

# 長いオプションのパース
while [[ $# -gt 0 ]]; do
    case $1 in
        --tags)
            TAGS="$2"
            shift 2
            ;;
        --resource-groups)
            RESOURCE_GROUPS="$2"
            shift 2
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --quiet)
            QUIET=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo "Error: Unknown option: $1" >&2
            usage
            ;;
    esac
done

# パラメータのバリデーション
# --tags も --resource-groups も指定されていない場合はエラー
if [[ -z "$TAGS" ]] && [[ -z "$RESOURCE_GROUPS" ]]; then
    echo "Error: At least one of --tags or --resource-groups must be specified" >&2
    usage
fi

# Azure 認証
if [[ -n "${AZURE_CLIENT_ID:-}" ]] && \
   [[ -n "${AZURE_CLIENT_SECRET:-}" ]] && \
   [[ -n "${AZURE_TENANT_ID:-}" ]]; then
    # サービスプリンシパル認証
    log "Logging in to Azure with Service Principal..."
    az login --service-principal \
        -u "$AZURE_CLIENT_ID" \
        -p "$AZURE_CLIENT_SECRET" \
        --tenant "$AZURE_TENANT_ID" \
        --output none
    log "Successfully logged in to Azure"
else
    # マネージドID認証を試す（失敗したら対話的ログイン）
    log "Logging in to Azure with Managed Identity..."
    if ! az login --identity --output none 2>/dev/null; then
        log "Managed Identity authentication failed, falling back to interactive login..."
        az login
    fi
fi

# VMを検索するJMESPathクエリを構築
if [[ -n "$TAGS" ]]; then
    TAG_FILTER=$(build_tag_filter "$TAGS")
    QUERY="[?$TAG_FILTER].{Name:name, ResourceGroup:resourceGroup, PowerState:powerState, Tags:tags}"
    log "Searching for VMs with tags: $TAGS..."
else
    QUERY="[].{Name:name, ResourceGroup:resourceGroup, PowerState:powerState, Tags:tags}"
    log "Searching for all VMs..."
fi

if [[ -n "$RESOURCE_GROUPS" ]]; then
    log "Resource group filter: $RESOURCE_GROUPS"
    # 複数のリソースグループに対応
    VMS="[]"
    IFS=',' read -ra RG_ARRAY <<< "$RESOURCE_GROUPS"
    for rg in "${RG_ARRAY[@]}"; do
        rg_vms=$(az vm list -g "$rg" --show-details --query "$QUERY" -o json 2>/dev/null || echo "[]")
        VMS=$(echo "$VMS" "$rg_vms" | jq -s 'add')
    done
else
    VMS=$(az vm list --show-details --query "$QUERY" -o json)
fi

# VM数を確認
VM_COUNT=$(echo "$VMS" | jq '. | length')

if [[ "$VM_COUNT" -eq 0 ]]; then
    if [[ -n "$TAGS" ]]; then
        log "No VMs found with tags: $TAGS"
    else
        log "No VMs found"
    fi
    exit 0
fi

log "Found $VM_COUNT VM(s):"
if [[ "$QUIET" != true ]]; then
    echo "$VMS" | jq -r '.[] | "  - \(.Name) (Resource Group: \(.ResourceGroup), Power State: \(.PowerState), Tags: \(.Tags | to_entries | map("\(.key)=\(.value)") | join(", ")))"'
fi

if [[ "$DRY_RUN" == true ]]; then
    log ""
    log "Dry run mode - no VMs will be stopped"
    exit 0
fi

# 確認プロンプト（quietモードではスキップ）
if [[ "$QUIET" != true ]]; then
    echo ""
    read -p "Do you want to stop these VMs? (yes/no): " -r
    if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]] && [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Operation cancelled"
        exit 0
    fi
fi

# VMを停止
log ""
log "Stopping VMs..."

SUCCESS_COUNT=0
FAILURE_COUNT=0

while read -r vm; do
    VM_NAME=$(echo "$vm" | jq -r '.Name')
    VM_RG=$(echo "$vm" | jq -r '.ResourceGroup')
    POWER_STATE=$(echo "$vm" | jq -r '.PowerState')

    if [[ "$POWER_STATE" == "VM deallocated" ]] || [[ "$POWER_STATE" == "VM stopped" ]] || [[ "$POWER_STATE" == "VM deallocating" ]]; then
        log "  ⏭  $VM_NAME is already stopped or stopping (skipping)"
        continue
    fi

    log "  ⏸  Stopping $VM_NAME in resource group $VM_RG..."

    if az vm deallocate -n "$VM_NAME" -g "$VM_RG" --no-wait; then
        log "  ✓  Stop command sent for $VM_NAME"
        ((SUCCESS_COUNT++))
    else
        echo "  ✗  Failed to stop $VM_NAME" >&2
        ((FAILURE_COUNT++))
    fi
done < <(echo "$VMS" | jq -c '.[]')

log ""
log "Stop operation completed"
log "Note: VMs are being stopped asynchronously. Use 'az vm list --show-details' to check current status."
