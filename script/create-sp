#!/bin/bash

set -euo pipefail

# スクリプトのディレクトリを取得
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# 使用方法を表示
usage() {
    cat <<EOF
Usage: $0 [options]

Create an Azure Service Principal with a custom role for VM start/stop operations.

Options:
    --name <name>              Service Principal name (default: vm-management-sp)
    --role-name <role_name>    Custom role name (default: VM Start Stop Operator)
    -h, --help                 Show this help message

The custom role will have only these permissions:
    - Microsoft.Compute/virtualMachines/start/action
    - Microsoft.Compute/virtualMachines/deallocate/action
    - Microsoft.Compute/virtualMachines/read

Example:
    $0 
    $0  --name my-sp
EOF
    exit 1
}

# パラメータ初期化
SP_NAME="vm-stop-start-management-sp"
ROLE_NAME="VM Start Stop Operator"

# オプション解析
while [[ $# -gt 0 ]]; do
    case $1 in
        --name)
            SP_NAME="$2"
            shift 2
            ;;
        --role-name)
            ROLE_NAME="$2"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo "Error: Unknown option: $1" >&2
            usage
            ;;
    esac
done

# Azure CLIがインストールされているかチェック
if ! command -v az &> /dev/null; then
    echo "Error: Azure CLI (az) is not installed" >&2
    echo "Please install it from: https://learn.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest" >&2
    exit 1
fi

# jqがインストールされているかチェック
if ! command -v jq &> /dev/null; then
    echo "Error: jq is not installed" >&2
    echo "Please install jq to parse JSON output" >&2
    exit 1
fi

# Azureにログイン
az login

# サブスクリプションIDを取得
SUBSCRIPTION_ID=$(az account show --query id --output tsv)

# カスタムロール定義ファイルを作成
ROLE_DEF_FILE=$(mktemp)
trap "rm -f $ROLE_DEF_FILE" EXIT

cat > "$ROLE_DEF_FILE" <<EOF
{
  "Name": "$ROLE_NAME",
  "IsCustom": true,
  "Description": "Can start and stop virtual machines",
  "Actions": [
    "Microsoft.Compute/virtualMachines/start/action",
    "Microsoft.Compute/virtualMachines/deallocate/action",
    "Microsoft.Compute/virtualMachines/read"
  ],
  "NotActions": [],
  "AssignableScopes": [
    "/subscriptions/$SUBSCRIPTION_ID"
  ]
}
EOF

# 既存のロールをチェック
EXISTING_ROLE=$(az role definition list --output json | jq --arg roleName "$ROLE_NAME" '.[] | select(.roleName == $roleName)')

if [[ -n "$EXISTING_ROLE" ]]; then
    echo "ℹ  Custom role '$ROLE_NAME' already exists. Skipping role creation."
else
    # カスタムロールを作成
    echo "Creating custom role..."
    if az role definition create --role-definition "$ROLE_DEF_FILE" --output none; then
        echo "✓ Custom role '$ROLE_NAME' created successfully!"
    else
        echo "Error: Failed to create custom role" >&2
        exit 1
    fi
fi

echo ""
echo "Creating Service Principal: $SP_NAME"
echo ""

# Service Principalを作成
set +e
# stderrとstdoutを分離して、警告メッセージを除外
SP_OUTPUT=$(az ad sp create-for-rbac \
    --name "$SP_NAME" \
    --role "$ROLE_NAME" \
    --scopes "/subscriptions/$SUBSCRIPTION_ID" \
    --output json 2>/dev/null)
SP_EXIT_CODE=$?
set -e

if [[ $SP_EXIT_CODE -ne 0 ]]; then
    # エラーの場合は詳細を再取得
    SP_ERROR=$(az ad sp create-for-rbac \
        --name "$SP_NAME" \
        --role "$ROLE_NAME" \
        --scopes "/subscriptions/$SUBSCRIPTION_ID" \
        --output json 2>&1) || true

    # エラーメッセージに既に存在するという内容が含まれているかチェック
    if echo "$SP_ERROR" | grep -q "already exists"; then
        echo "ℹ  Service Principal '$SP_NAME' already exists."
        echo "Please use a different name with --name option, or delete the existing one first:" >&2
        echo "  az ad sp delete --id \$(az ad sp list --display-name '$SP_NAME' --query '[0].appId' -o tsv)" >&2
        exit 1
    else
        echo "Error: Failed to create Service Principal" >&2
        echo "$SP_ERROR" >&2
        exit 1
    fi
fi

# JSONが有効か検証
if ! echo "$SP_OUTPUT" | jq empty 2>/dev/null; then
    echo "Error: Service Principal was created but returned invalid JSON" >&2
    echo "Output received:" >&2
    echo "$SP_OUTPUT" >&2
    exit 1
fi

# 認証情報を抽出
AZURE_CLIENT_ID=$(echo "$SP_OUTPUT" | jq -r '.appId')
AZURE_CLIENT_SECRET=$(echo "$SP_OUTPUT" | jq -r '.password')
AZURE_TENANT_ID=$(echo "$SP_OUTPUT" | jq -r '.tenant')

echo "✓ Service Principal created successfully!"
echo ""

# .env形式で出力
cat > "$PROJECT_ROOT/.env" <<EOF
# Azure Service Principal credentials
AZURE_CLIENT_ID=$AZURE_CLIENT_ID
AZURE_CLIENT_SECRET=$AZURE_CLIENT_SECRET
AZURE_TENANT_ID=$AZURE_TENANT_ID
EOF

echo "✓ .env file created at $PROJECT_ROOT/.env"
