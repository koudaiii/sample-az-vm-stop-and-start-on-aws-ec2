#!/bin/bash

set -euo pipefail

# スクリプトのディレクトリを取得
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# 使用方法を表示
usage() {
    cat <<EOF
Usage: $0 [options]

Create an Azure Service Principal with a custom role for VM start/stop operations.
This script is idempotent - it can be run multiple times safely:
  - If the Service Principal exists, credentials will be reset
  - If the custom role exists, it will be updated with the latest definition
  - If the role assignment exists, it will be skipped

Options:
    --name <name>              Service Principal name (default: vm-management-sp)
    --role-name <role_name>    Custom role name (default: VM Start Stop Operator)
    -h, --help                 Show this help message

The custom role will have only these permissions:
    - Microsoft.Compute/virtualMachines/start/action
    - Microsoft.Compute/virtualMachines/deallocate/action
    - Microsoft.Compute/virtualMachines/read
    - Microsoft.Compute/virtualMachines/instanceView/read
    - Microsoft.Network/networkInterfaces/read

Example:
    $0
    $0  --name my-sp
EOF
    exit 1
}

# パラメータ初期化
SP_NAME="vm-stop-start-management-sp"
ROLE_NAME="VM Start Stop Operator"

# オプション解析
while [[ $# -gt 0 ]]; do
    case $1 in
        --name)
            SP_NAME="$2"
            shift 2
            ;;
        --role-name)
            ROLE_NAME="$2"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo "Error: Unknown option: $1" >&2
            usage
            ;;
    esac
done

# Azure CLIがインストールされているかチェック
if ! command -v az &> /dev/null; then
    echo "Error: Azure CLI (az) is not installed" >&2
    echo "Please install it from: https://learn.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest" >&2
    exit 1
fi

# jqがインストールされているかチェック
if ! command -v jq &> /dev/null; then
    echo "Error: jq is not installed" >&2
    echo "Please install jq to parse JSON output" >&2
    exit 1
fi

# Azureにログイン
az login

# サブスクリプションIDを取得
SUBSCRIPTION_ID=$(az account show --query id --output tsv)

# カスタムロール定義ファイルを作成
ROLE_DEF_FILE=$(mktemp)
trap "rm -f $ROLE_DEF_FILE" EXIT

cat > "$ROLE_DEF_FILE" <<EOF
{
  "Name": "$ROLE_NAME",
  "IsCustom": true,
  "Description": "Can start, stop, and read virtual machines",
  "Actions": [
    "Microsoft.Compute/virtualMachines/start/action",
    "Microsoft.Compute/virtualMachines/deallocate/action",
    "Microsoft.Compute/virtualMachines/read",
    "Microsoft.Compute/virtualMachines/instanceView/read",
    "Microsoft.Network/networkInterfaces/read"
  ],
  "NotActions": [],
  "AssignableScopes": [
    "/subscriptions/$SUBSCRIPTION_ID"
  ]
}
EOF

# 既存のロールをチェック
EXISTING_ROLE=$(az role definition list --output json | jq --arg roleName "$ROLE_NAME" '.[] | select(.roleName == $roleName)')

if [[ -n "$EXISTING_ROLE" ]]; then
    echo "ℹ  Custom role '$ROLE_NAME' already exists. Updating role definition..."
    if az role definition update --role-definition "$ROLE_DEF_FILE" --output none; then
        echo "✓ Custom role '$ROLE_NAME' updated successfully!"
    else
        echo "Error: Failed to update custom role" >&2
        exit 1
    fi
else
    # カスタムロールを作成
    echo "Creating custom role..."
    if az role definition create --role-definition "$ROLE_DEF_FILE" --output none; then
        echo "✓ Custom role '$ROLE_NAME' created successfully!"
    else
        echo "Error: Failed to create custom role" >&2
        exit 1
    fi
fi

echo ""
echo "Checking for existing Service Principal: $SP_NAME"
echo ""

# 既存のService Principalをチェック
EXISTING_SP_APP_ID=$(az ad sp list --display-name "$SP_NAME" --query '[0].appId' -o tsv 2>/dev/null || echo "")

if [[ -n "$EXISTING_SP_APP_ID" ]]; then
    echo "ℹ  Service Principal '$SP_NAME' already exists (App ID: $EXISTING_SP_APP_ID)"
    echo "Resetting credentials..."

    # 既存のService Principalのシークレットをリセット
    SP_OUTPUT=$(az ad sp credential reset \
        --id "$EXISTING_SP_APP_ID" \
        --output json 2>/dev/null)

    if [[ $? -ne 0 ]]; then
        echo "Error: Failed to reset Service Principal credentials" >&2
        exit 1
    fi

    echo "✓ Service Principal credentials reset successfully!"

    # ロール割り当てが存在するかチェック
    EXISTING_ROLE_ASSIGNMENT=$(az role assignment list \
        --assignee "$EXISTING_SP_APP_ID" \
        --role "$ROLE_NAME" \
        --scope "/subscriptions/$SUBSCRIPTION_ID" \
        --query '[0].id' -o tsv 2>/dev/null || echo "")

    if [[ -z "$EXISTING_ROLE_ASSIGNMENT" ]]; then
        echo "Assigning role '$ROLE_NAME' to Service Principal..."
        az role assignment create \
            --assignee "$EXISTING_SP_APP_ID" \
            --role "$ROLE_NAME" \
            --scope "/subscriptions/$SUBSCRIPTION_ID" \
            --output none
        echo "✓ Role assigned successfully!"
    else
        echo "ℹ  Role '$ROLE_NAME' already assigned to Service Principal"
    fi
else
    echo "Creating new Service Principal: $SP_NAME"

    # 新規Service Principalを作成
    SP_OUTPUT=$(az ad sp create-for-rbac \
        --name "$SP_NAME" \
        --role "$ROLE_NAME" \
        --scopes "/subscriptions/$SUBSCRIPTION_ID" \
        --output json 2>/dev/null)

    if [[ $? -ne 0 ]]; then
        echo "Error: Failed to create Service Principal" >&2
        exit 1
    fi

    echo "✓ Service Principal created successfully!"
fi

# JSONが有効か検証
if ! echo "$SP_OUTPUT" | jq empty 2>/dev/null; then
    echo "Error: Received invalid JSON from Azure CLI" >&2
    echo "Output received:" >&2
    echo "$SP_OUTPUT" >&2
    exit 1
fi

# 認証情報を抽出
AZURE_CLIENT_ID=$(echo "$SP_OUTPUT" | jq -r '.appId')
AZURE_CLIENT_SECRET=$(echo "$SP_OUTPUT" | jq -r '.password')
AZURE_TENANT_ID=$(echo "$SP_OUTPUT" | jq -r '.tenant')

echo ""

# .env形式で出力
cat > "$PROJECT_ROOT/.env" <<EOF
# Azure Service Principal credentials
AZURE_CLIENT_ID=$AZURE_CLIENT_ID
AZURE_CLIENT_SECRET=$AZURE_CLIENT_SECRET
AZURE_TENANT_ID=$AZURE_TENANT_ID
EOF

echo "✓ .env file created at $PROJECT_ROOT/.env"
