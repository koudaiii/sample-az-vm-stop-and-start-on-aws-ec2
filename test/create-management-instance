#!/bin/bash

# ec2-create
# This script creates an EC2 instance using AWS CLI.
set -e
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Variables
REGION="${AWS_REGION:-us-east-1}"
KEY_NAME="azure-vm-controller-key"
KEY_PATH="$HOME/.ssh/ed25519_keypair"
VPC_NAME="azure-vm-controller-vpc"
SG_NAME="azure-vm-controller-sg"
INSTANCE_TYPE="t2.micro"
VPC_CIDR="10.0.0.0/16"
SUBNET_CIDR="10.0.1.0/24"

# Get the latest Amazon Linux 2023 AMI ID
echo "Getting latest Amazon Linux 2023 AMI..."
AMI_ID=$(aws ec2 describe-images \
    --region "$REGION" \
    --owners amazon \
    --filters "Name=name,Values=al2023-ami-2023.*-x86_64" "Name=state,Values=available" \
    --query 'sort_by(Images, &CreationDate)[-1].ImageId' \
    --output text)

echo "Using AMI: $AMI_ID"

# Create SSH key pair if it doesn't exist
if [ ! -f "$KEY_PATH" ]; then
    echo "Creating SSH key pair..."
    ssh-keygen -t ed25519 -f "$KEY_PATH" -N "" -C "azure-vm-controller"
    chmod 600 "$KEY_PATH"
fi

# Import or create key pair in AWS
if ! aws ec2 describe-key-pairs --region "$REGION" --key-names "$KEY_NAME" &>/dev/null; then
    echo "Importing key pair to AWS..."
    aws ec2 import-key-pair \
        --region "$REGION" \
        --key-name "$KEY_NAME" \
        --public-key-material "fileb://${KEY_PATH}.pub"
else
    echo "Key pair already exists in AWS"
fi

# Create VPC if it doesn't exist
VPC_ID=$(aws ec2 describe-vpcs \
    --region "$REGION" \
    --filters "Name=tag:Name,Values=$VPC_NAME" \
    --query 'Vpcs[0].VpcId' \
    --output text 2>/dev/null)

if [ "$VPC_ID" = "None" ] || [ -z "$VPC_ID" ]; then
    echo "Creating VPC..."
    VPC_ID=$(aws ec2 create-vpc \
        --region "$REGION" \
        --cidr-block "$VPC_CIDR" \
        --tag-specifications "ResourceType=vpc,Tags=[{Key=Name,Value=$VPC_NAME}]" \
        --query 'Vpc.VpcId' \
        --output text)
    
    # Enable DNS hostnames
    aws ec2 modify-vpc-attribute \
        --region "$REGION" \
        --vpc-id "$VPC_ID" \
        --enable-dns-hostnames
    
    echo "VPC created: $VPC_ID"
else
    echo "VPC already exists: $VPC_ID"
fi

# Create Internet Gateway if it doesn't exist
IGW_ID=$(aws ec2 describe-internet-gateways \
    --region "$REGION" \
    --filters "Name=tag:Name,Values=${VPC_NAME}-igw" \
    --query 'InternetGateways[0].InternetGatewayId' \
    --output text 2>/dev/null)

if [ "$IGW_ID" = "None" ] || [ -z "$IGW_ID" ]; then
    echo "Creating Internet Gateway..."
    IGW_ID=$(aws ec2 create-internet-gateway \
        --region "$REGION" \
        --tag-specifications "ResourceType=internet-gateway,Tags=[{Key=Name,Value=${VPC_NAME}-igw}]" \
        --query 'InternetGateway.InternetGatewayId' \
        --output text)
    
    # Attach to VPC
    aws ec2 attach-internet-gateway \
        --region "$REGION" \
        --vpc-id "$VPC_ID" \
        --internet-gateway-id "$IGW_ID"
    
    echo "Internet Gateway created: $IGW_ID"
else
    echo "Internet Gateway already exists: $IGW_ID"
fi

# Create Subnet if it doesn't exist
SUBNET_ID=$(aws ec2 describe-subnets \
    --region "$REGION" \
    --filters "Name=vpc-id,Values=$VPC_ID" "Name=tag:Name,Values=${VPC_NAME}-subnet" \
    --query 'Subnets[0].SubnetId' \
    --output text 2>/dev/null)

if [ "$SUBNET_ID" = "None" ] || [ -z "$SUBNET_ID" ]; then
    echo "Creating Subnet..."
    SUBNET_ID=$(aws ec2 create-subnet \
        --region "$REGION" \
        --vpc-id "$VPC_ID" \
        --cidr-block "$SUBNET_CIDR" \
        --tag-specifications "ResourceType=subnet,Tags=[{Key=Name,Value=${VPC_NAME}-subnet}]" \
        --query 'Subnet.SubnetId' \
        --output text)
    
    # Enable auto-assign public IP
    aws ec2 modify-subnet-attribute \
        --region "$REGION" \
        --subnet-id "$SUBNET_ID" \
        --map-public-ip-on-launch
    
    echo "Subnet created: $SUBNET_ID"
else
    echo "Subnet already exists: $SUBNET_ID"
fi

# Create or update route table
ROUTE_TABLE_ID=$(aws ec2 describe-route-tables \
    --region "$REGION" \
    --filters "Name=vpc-id,Values=$VPC_ID" "Name=tag:Name,Values=${VPC_NAME}-rt" \
    --query 'RouteTables[0].RouteTableId' \
    --output text 2>/dev/null)

if [ "$ROUTE_TABLE_ID" = "None" ] || [ -z "$ROUTE_TABLE_ID" ]; then
    echo "Creating Route Table..."
    ROUTE_TABLE_ID=$(aws ec2 create-route-table \
        --region "$REGION" \
        --vpc-id "$VPC_ID" \
        --tag-specifications "ResourceType=route-table,Tags=[{Key=Name,Value=${VPC_NAME}-rt}]" \
        --query 'RouteTable.RouteTableId' \
        --output text)
    
    echo "Route Table created: $ROUTE_TABLE_ID"
else
    echo "Route Table already exists: $ROUTE_TABLE_ID"
fi

# Add route to Internet Gateway
aws ec2 create-route \
    --region "$REGION" \
    --route-table-id "$ROUTE_TABLE_ID" \
    --destination-cidr-block 0.0.0.0/0 \
    --gateway-id "$IGW_ID" 2>/dev/null || echo "Route already exists"

# Associate route table with subnet
aws ec2 associate-route-table \
    --region "$REGION" \
    --subnet-id "$SUBNET_ID" \
    --route-table-id "$ROUTE_TABLE_ID" 2>/dev/null || echo "Route table already associated"

# Create security group if it doesn't exist
SG_ID=$(aws ec2 describe-security-groups \
    --region "$REGION" \
    --filters "Name=group-name,Values=$SG_NAME" "Name=vpc-id,Values=$VPC_ID" \
    --query 'SecurityGroups[0].GroupId' \
    --output text 2>/dev/null)

if [ "$SG_ID" = "None" ] || [ -z "$SG_ID" ]; then
    echo "Creating security group..."
    SG_ID=$(aws ec2 create-security-group \
        --region "$REGION" \
        --group-name "$SG_NAME" \
        --description "Security group for Azure VM controller - SSH access" \
        --vpc-id "$VPC_ID" \
        --query 'GroupId' \
        --output text)
    
    echo "Adding SSH rule to security group..."
    aws ec2 authorize-security-group-ingress \
        --region "$REGION" \
        --group-id "$SG_ID" \
        --protocol tcp \
        --port 22 \
        --cidr 0.0.0.0/0
    
    echo "Security group created: $SG_ID"
else
    echo "Security group already exists: $SG_ID"
fi

# Launch EC2 instance
echo "Launching EC2 instance..."
INSTANCE_ID=$(aws ec2 run-instances \
    --region "$REGION" \
    --image-id "$AMI_ID" \
    --count 1 \
    --instance-type "$INSTANCE_TYPE" \
    --key-name "$KEY_NAME" \
    --security-group-ids "$SG_ID" \
    --subnet-id "$SUBNET_ID" \
    --user-data "file://$SCRIPT_DIR/cloud-init" \
    --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=azure-vm-controller}]" \
    --query 'Instances[0].InstanceId' \
    --output text)

echo "EC2 instance created: $INSTANCE_ID"
echo "Waiting for instance to be running..."

aws ec2 wait instance-running --region "$REGION" --instance-ids "$INSTANCE_ID"

# Get instance public IP
PUBLIC_IP=$(aws ec2 describe-instances \
    --region "$REGION" \
    --instance-ids "$INSTANCE_ID" \
    --query 'Reservations[0].Instances[0].PublicIpAddress' \
    --output text)

echo ""
echo "=========================================="
echo "EC2 instance created successfully!"
echo "=========================================="
echo "Region: $REGION"
echo "VPC ID: $VPC_ID"
echo "Subnet ID: $SUBNET_ID"
echo "Security Group ID: $SG_ID"
echo "Instance ID: $INSTANCE_ID"
echo "Public IP: $PUBLIC_IP"
echo "SSH Key: $KEY_PATH"
echo ""
echo "Connect using:"
echo "  ssh -i $KEY_PATH ec2-user@$PUBLIC_IP"
echo ""
echo "Cleanup (delete all resources):"
echo "  aws ec2 terminate-instances --region $REGION --instance-ids $INSTANCE_ID"
echo "  # Wait for instance termination, then:"
echo "  aws ec2 delete-security-group --region $REGION --group-id $SG_ID"
echo "  aws ec2 delete-subnet --region $REGION --subnet-id $SUBNET_ID"
echo "  aws ec2 detach-internet-gateway --region $REGION --vpc-id $VPC_ID --internet-gateway-id $IGW_ID"
echo "  aws ec2 delete-internet-gateway --region $REGION --internet-gateway-id $IGW_ID"
echo "  aws ec2 delete-route-table --region $REGION --route-table-id $ROUTE_TABLE_ID"
echo "  aws ec2 delete-vpc --region $REGION --vpc-id $VPC_ID"
echo "=========================================="


